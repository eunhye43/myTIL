### âœï¸ í˜¼ì ì—°ìŠµí•˜ë ¤ê³  ê¸°ë¡í•˜ëŠ” ë¸”ë¡œê¹….. ^^

ğŸ¼ ëª°ëë˜ ë¶€ë¶„ & í—·ê°ˆë¦° ë¶€ë¶„ë§Œ ì •ë¦¬
* Subquery ì¿¼ë¦¬ ì•ˆì˜ ì¿¼ë¦¬! (ë” í¸í•˜ê³  ê°„ë‹¨í•˜ê²Œ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆì”€!)
1) where ì ˆ ì•ˆì— queryë¬¸ ë„£ê¸°
```
select u.user_id, u.name, u.email from users u 
inner join orders o on u.user_id = o.user_id 
where o.payment_method = 'kakaopay'
```
-> ì´ ì½”ë“œë¥¼ subqueryë¥¼ í™œìš©í•´ì„œ ë™ì¼í•˜ê²Œ ë§Œë“¤ì–´ë³´ì¥ !
```
select user_id, name, email from users u 
where user_id in (
	select user_id from orders o 
	where payment_method = 'kakaopay'
)
# í° ì¿¼ë¦¬ë¬¸ ì•ˆì— ë“¤ì–´ê°€ëŠ” ì‘ì€ ì¿¼ë¦¬ë¬¸.
# ê°€ì¥ ì•ˆì— ë“¤ì–´ê°€ìˆëŠ” ì¿¼ë¦¬ë¬¸ë¶€í„° ì‹œì‘í•´ì„œ ê²°ê³¼ë¥¼ ë§Œë“¤ê³  ê·¸ ë‹¤ìŒ ë°–ì— ìˆëŠ”ê±¸ ì‹¤í–‰í•¨
# in ì•ˆì— ë“¤ì–´ìˆëŠ” ì¿¼ë¦¬ë¬¸ì— í•´ë‹¹í•˜ëŠ” user_idë§Œ ê±¸ëŸ¬ë‚¼ê±°ì•¼~~~
```
2) selectë¬¸ ì•ˆì— queryë¬¸ ë„£ê¸°
```
select c.checkin_id, 
	   c.user_id, 
	   c.likes,
	   (
		select avg(likes) from checkins
		where user_id =c.user_id
		) as avg_likes_user
  from checkins c
# c.user_idì™€ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤ì˜ í‰ê· ê°’ë“¤ì„ ë‹¤ ì¶”ì¶œí•´ì¤˜~~
```
3) fromì ˆ ì•ˆì— queryë¬¸ ë„£ê¸°
```
select pu.user_id, pu.point, a.avg_likes from point_users pu
inner join (
	select user_id, round(avg(likes),1) as avg_likes from checkins c 
	group by user_id 
) a on pu.user_id = a.user_id
# ë‚´ê°€ ì§€ê¸ˆ ë§Œë“  selectë¬¸ì„ ë§ˆì¹˜ ì›ë˜ë¶€í„° ìˆì—ˆë˜ í…Œì´ë¸”ë¡œ ì‚¬ìš©í•˜ëŠ”ê²Œ from ì ˆ ì•ˆì— ìˆëŠ” subquery
```
![](https://images.velog.io/images/majaeh43/post/aff4f315-d80a-4fed-bcdb-551c6e7b4b20/image.png)

4) Subquery ì—°ìŠµ(where, select)
ğŸŒ± í€´ì¦ˆ1
![](https://images.velog.io/images/majaeh43/post/30676dfe-7a96-4c88-b609-6948a15d87af/image.png)
```
select * from point_users pu 
where point > (
	select avg(point) from point_users pu 
)
```
ğŸŒ± í€´ì¦ˆ2
![](https://images.velog.io/images/majaeh43/post/5e80975c-18ef-4334-9089-ce420c2fb9f2/image.png)
```
#1
select * from point_users pu 
where point > (
	select avg(point) from point_users pu
	inner join users u2 on pu.user_id = u2.user_id
	where name = 'ì´**'
)

#2
select * from point_users pu 
where point > (
	select avg(point) from point_users pu 
	where user_id in (
	select user_id from users where name = 'ì´**'
	)
)
# subqueryì•ˆì— subquery~~~
```

ğŸŒ± í€´ì¦ˆ3
![](https://images.velog.io/images/majaeh43/post/5023989f-0f6a-47d7-86e4-97c7d01f9783/image.png)
-> ë‚´ë‹µì•ˆ
```
select checkin_id, 
	   course_id, 
	   user_id, 
	   likes, (
		select avg(likes) from checkins c
		group by course_id
				) 
		as course_avg from checkins c
```
-> ì •ë‹µ
```
select c.checkin_id, 
	   c.course_id, 
	   c.user_id, 
	   c.likes, (
		select avg(likes) from checkins c
		where course_id = c.course_id
				) 
		as course_avg from checkins c
```
* ë‚œ course_idë³„ í‰ê·  likesê°’ì„ êµ¬í•  ë•Œ ë‚˜ëŠ” group byë¥¼ ì¨ì£¼ì—ˆëŠ”ë° ìƒ˜ì€ whereì ˆë¡œ course_id = c.course_idë¥¼ ì¨ì£¼ì—ˆë‹¤. ë­ê°€ ë‹¤ë¥¸ê±¸ê¹Œ? ... ê³ ë¯¼!

5) Subquery ì—°ìŠµ(from, inner join)
ğŸŒ± í€´ì¦ˆ1
![](https://images.velog.io/images/majaeh43/post/19e9f212-44ba-4bd4-8642-e2979d73a57b/image.png)
```
select c.course_id, COUNT(DISTINCT(user_id)) as cnt_checkins from checkins c
group by course_id
# countì•ˆì— distinctë„£ê¸°!! ì£¼ì˜!!
```
ğŸŒ± í€´ì¦ˆ2
![](https://images.velog.io/images/majaeh43/post/ecf9e631-4875-4db8-8018-4e9de37abee3/image.png)
```
select course_id, count(user_id) as cnt_total from orders o 
group by course_id
```
ğŸŒ± í€´ì¦ˆ3
![](https://images.velog.io/images/majaeh43/post/781c0a32-766e-4930-8ac2-57b60fc018e7/image.png)
-> ë‚´ ë‹µì•ˆ
```
select c.course_id, 
	   COUNT(DISTINCT(c.user_id)) as cnt_checkins,
	   count(*) as cnt_total
	   from checkins c
inner join orders o on c.user_id = o.user_id 
group by c.course_id

# checkinsí…Œì´ë¸”ê³¼ orders í…Œì´ë¸”ì„ inner join í•´ì£¼ì—ˆëŠ”ë°
# count ì„¸ì–´ì¤„ ë•Œ cnt_totalì´ ì•ˆë¨¹íŒë‹¤. ì™œëƒë©´ ì´ê±´ orders í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¨ê±°ë¼
# select êµ¬ë¬¸ì„ ì½ì–´ì¤„ ë•Œ ë’¤ì— inner joinì— ë‚˜ì˜¤ëŠ” ordersë¥¼ ëª»ì½ëŠ” ê²ƒ ê°™ë‹¤
# ì–´ë–»ê²Œ í•´ì•¼ë‚˜ì˜¬ê¹Œ??
```
-> ìƒ˜ ë‹µì•ˆ
```
select a.course_id, a.cnt_checkins, b.cnt_total from 
(
select course_id, 
	   count(DISTINCT(user_id)) as cnt_checkins 
	   from checkins
group by course_id
) a
inner join 
(
select course_id, count(*) as cnt_total 
	   from orders
group by course_id
) b on a.course_id = b.course_id 

# í¬ê²Œ ìª¼ê°œë³´ë©´
# select * from () a
# inner join () b on ì¡°ê±´
# ì € ê´„í˜¸ ì•ˆì— ê°ê°ì˜ selectë¬¸ì„ ë„£ì–´ì£¼ëŠ” ê²ƒ... ì•„ ë„ˆë¬´ ì‹ ê¸°í•œë° ë„ˆë¬´ í—·ê°ˆë ¹..ã… ã… 
ğŸ¦–
```
ğŸŒ± í€´ì¦ˆ4
![](https://images.velog.io/images/majaeh43/post/19a55e84-a0ee-43ca-8db5-bb57df88b79b/image.png)
```
select a.course_id, a.cnt_checkins, b.cnt_total, a.cnt_checkins/b.cnt_total as ratio from (select course_id, count(DISTINCT(user_id)) as cnt_checkins from checkins c
group by course_id) a
inner join (select course_id, count(*) as cnt_total from orders o
group by course_id) b on a.course_id = b.course_id
```
ğŸŒ± í€´ì¦ˆ5
![](https://images.velog.io/images/majaeh43/post/0405774c-ada0-4f48-8bcd-cd0bcc4669ed/image.png)
```
select c.title,
	   a.cnt_checkins, 
	   b.cnt_total, 
	   a.cnt_checkins/b.cnt_total as ratio
	   from 
	   (select course_id, count(DISTINCT(user_id)) as cnt_checkins 
	   from checkins c
	   group by course_id) a
inner join (select course_id, count(*) as cnt_total 
	   from orders o
	   group by course_id) b 
	   on a.course_id = b.course_id
inner join (select * from courses) c 
	   on c.course_id = b.course_id
       
# inner join 2ê°œ ë“¤ì–´ê°ˆ ë–„ ê·¸ëƒ¥ ë°‘ì—ë‹¤ê°€ ì¨ì£¼ë©´ ë ë“¯ ~!
```
* with ì ˆ ì—°ìŠµ!!
```
with table1 as (
	select course_id, count(DISTINCT(user_id)) as cnt_checkins from checkins c
	group by course_id
),	 table2 as (
	select course_id, count(*) as cnt_total from orders o
	group by course_id
)
# table1ê³¼ table2ê°€ ì„ì‹œí…Œì´ë¸”ì²˜ëŸ¼ í™œìš©ë¨. aliasë¡œ select êµ¬ë¬¸ì„ ë„£ì–´ì£¼ëŠ” ê²ƒì„ !
```
-> with ì ˆì„ ì‚¬ìš©í•´ì„œ ì¢€ë” ê°€ë…ì„±ì„ ë†’ì—¬ë³´ì¥ ! ìš”ëŸ¬ì¼€~~
```
with table1 as (
	select course_id, count(DISTINCT(user_id)) as cnt_checkins from checkins c
	group by course_id
),	 table2 as (
	select course_id, count(*) as cnt_total from orders o
	group by course_id
)

select c.title, a.cnt_checkins, b.cnt_total, a.cnt_checkins/b.cnt_total as ratio
	   from table1 a
inner join table2 b 
	   on a.course_id = b.course_id
inner join (select * from courses) c 
	   on c.course_id = b.course_id
```
* ì‹¤ì „ì—ì„œ ìœ ìš©í•œ SQL ë¬¸ë²•!! (ë¬¸ìì—´)
* ë¬¸ìì—´ ìª¼ê°œë³´ê¸°
-> SUBSTRING_INDEX ë¼ëŠ” ë¬¸ë²•ì„ ì‚¬ìš©í•´ë³´ëŠ” ê²ƒì´ì•¼ ! ğŸŒˆ
```
SUBSTRING_INDEX(email,'@',1)
# emailì„ '@'ê¸°ì¤€ìœ¼ë¡œ ìª¼ê°¤ê»€ë° ì²«ë²ˆì§¸ ê²ƒë§Œ ë³´ì—¬ì¤˜~!
# -1 í•˜ë©´? ë§ˆì§€ë§‰êº¼ë§Œ ë³´ì—¬ì¤˜~!
```
* ë¬¸ìì—´ ì¼ë¶€ë§Œ ì¶œë ¥í•˜ê¸°
-> SUBSTRING ì´ë¼ëŠ” ë¬¸ë²•ì„ ì‚¬ìš© !! ğŸŒˆ
```
substring(created_at,1,10)
# ì‹œì‘í¬ì¸íŠ¸, ì‹œì‘í¬ì¸íŠ¸ë¶€í„° ëª‡ì ìë¥¼ê±´ì§€!
```
* ì‹¤ì „ì—ì„œ ìœ ìš©í•œ SQL ë¬¸ë²•!! (Case)
```
case when pu.point > 10000 then 'ì˜í•˜ê³  ìˆì–´ìš”!'
	else 'ì¡°ê¸ˆë§Œ ë” í™”ì´íŒ…!' end
    
# í¬ì¸íŠ¸ê°€ 10000ë³´ë‹¤ í¬ë©´ ì˜í•˜ê³  ìˆì–´ìš” ë˜ëŠ”, ê·¸ê²Œ ì•„ë‹ˆë©´ ì¡°ê¸ˆë§Œ ë” í™”ì´íŒ…í•˜ê³  ë!
# selectêµ¬ë¬¸ì— ë“¤ì–´ê°€ëŠ” ê±¸ ê¸°ì–µí•´ì£¼...!

with table1 as (
	select pu.user_id, pu.point,
		(case when pu.point > 10000 then '1ë§Œ ì´ìƒ'
		  	  when pu.point > 5000 then '5ì²œ ì´ìƒ'
	          else '5ì²œë¯¸ë§Œ' end) as lv
		from point_users pu
		)


select a.lv, count(*) as cnt FROM table1 a
group by a.lv

# ìš”ê±´ with êµ¬ë¬¸ê¹Œì§€ í•©ì³ì§„ case when ë¬¸!
```
ğŸ“Œ ê³¼ì œ1
![](https://images.velog.io/images/majaeh43/post/df2a3fac-4c79-4a8b-b829-471cd20d3109/image.png)
```
ë‚´í’€ì´)
select pu.point_user_id, pu.point, 
	(case when pu.point >= avg(pu.point) then 'ì˜ í•˜ê³  ìˆì–´ìš”'
	 	else 'ì—´ì‹¬íˆ í•©ì‹œë‹¤!' end) as msg
	 from point_users pu
```
![](https://images.velog.io/images/majaeh43/post/078ea724-0f0a-401e-96fd-861c512990e9/image.png)
-> ì™œ ë°ì´í„°ê°€ í•˜ë‚˜ë°–ì— ì•ˆë‚˜ì˜¬ê¹Œ...?ã…....
```
ìƒ˜í’€ì´)
select pu.point_user_id, pu.point,
case 
when pu.point > (select avg(pu2.point) from point_users pu2) then 'ì˜ í•˜ê³  ìˆì–´ìš”!'
else 'ì—´ì‹¬íˆ í•©ì‹œë‹¤!'
end as 'msg'
from point_users pu

# avg(point) ë¶€ë¶„ì— select ì„œë¸Œì¿¼ë¦¬ë¥¼ ë„£ì–´ì¤¬ë„¤...?
# avg(point)ê°€ ë“¤ì–´ê°ˆ ìë¦¬ì— ì €ë ‡ê²Œë„ ë„£ì–´ì¤„ ìˆ˜ ìˆë‹¤ëŠ”ê²Œ ë„˜ ì‹ ê¸°.. ì €ë ‡ê²Œ ë„£ìœ¼ë‹ˆê¹Œ ì«˜ë¥´ë¥´ ë‹¤ ë‚˜ì˜´!
```
