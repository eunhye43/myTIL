<ê°œì¸ ê³µë¶€ë¥¼ ìœ„í•œ ë¸”ë¡œê¹…... ê°€ë…ì„±ì´ ë‚®ë‹¤.ğŸ˜®â€ğŸ’¨>
## ğŸ† select_related()
-> select_related ì€ foreign-key , one-to-one ì™€ ê°™ì€ single-valued relationshipsì—ì„œë§Œ ì‚¬ìš©ì´ ê°€ëŠ¥.
```
a = Entry.objects.get(id=5)
# Hits the database.

b = a.blog
# Hits the database again to get the related Blog object.

-> a, bëª¨ë‘ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê±´ë“œë¦°ë‹¤.


a = Entry.objects.select_related('blog').get(id=5)
# Hits the database again to get the related Blog object.

b = a.blog
# Doesn't hit the database, because a.blog has been prepopulated
# in the previous query.

-> aì—ì„œ ê´€ë ¨ ë¸”ë¡œê·¸ ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ê¸°ìœ„í•´ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ê±´ë“œë ¸ê³ , bì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤. ì™œëƒë©´ select_relatedë¥¼ í†µí•´ aê°€ ì°¸ì¡°í•˜ê³  ìˆëŠ” ëŒ€ìƒì„ caching. a.blogë¥¼ ì½ì„ ë•Œ ë‹¤ì‹œ dbë¡œ ê°ˆ í•„ìš” ì—†ì´ cachingë˜ì–´ìˆëŠ” ê°’ì„ ì½ì–´ì˜¤ë‹ˆê¹Œ db ì•ˆê±´ë“œë¦¼. ì´ê²Œ ë˜ê²Œ íš¨ìœ¨ì ì¸ ê²ƒ.
```
### ğŸ” ë” ê¹Šê²Œ ë“¤ì–´ê°€ë©´!
```
class City(models.Model):
  	name = models.CharField(max_length=20)
    
class Person(models.Model):
  	city = models.ForeignKey(City, on_delete=models.CASCADE)
      name = models.CharField(max_length=20)

class Pet(models.Model):
  	person = models.ForeignKey(Person, on_delete=models.CASCADE)
      name = models.CharField(max_length=20)
```
```
# Hits the database with joins to the person and city tables.
choon_sik = Pet.objects.select_related('person__city').get(id=1)
zunky = choon_sik.person         # Doesn't hit the database.
seoul = zunky.city       # Doesn't hit the database.
-> select_relatedë¥¼ í†µí•´ personê³¼ city í…Œì´ë¸”ì„ ì¡°ì¸, databaseë¥¼ í•œë²ˆë§Œ ê±´ë“¤ì´ê²Œë¨.

# Without select_related()...
choon_sik = Pet.objects.get(id=1)  # Hits the database.
zunky = choon_sik.person           # Hits the database.
seoul = zunky.city       # Hits the database

-> 3ë²ˆì„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê±´ë“¤ì´ê²Œ ë¨.
```
## ğŸ† prefetch_related()
-> prefetch_relatedëŠ” ManyToManyì™€ ê°™ì€ ê²½ìš° ì‚¬ìš©.
```
class City(models.Model):
  	name = models.CharField(max_length=20)

class Language(models.Model):
     name = models.CharField(max_length=100)
 
class Person(models.Model):
     city = models.ForeignKey(City, on_delete=models.CASCADE)
     name = models.CharField(max_length=20)
     language = models.ManyToManyField(Language, through='JoinPersonLanguage')
 
class JoinPersonLanguage(models.Model):
     person = models.ForeignKey(Person, on_delete=models.CASCADE)
     language = models.ForeignKey(Language, on_delete=models.CASCADE)
```
```
zunky = Person.objects.prefetch_related('language').get(id=1)
zunky.language.values() # Doesn't hit the database.
<QuerySet [{'id': 1, 'name': 'Python'}, {'id': 2, 'name': 'C'}, {'id': 4, 'name': 'Javascript'}]>
-> prefetch_relatedë¥¼ í†µí•´ zunky(person)ì—ì„œ languageë¥¼ ì°¸ì¡°í•´ì„œ ê°’ì„ ê°€ì ¸ì˜¬ ë•Œ database ì•ˆê±´ë“œë¦¼.

zunky = Person.objects.get(id=1)
zunky.language.values() # Hits the database.
<QuerySet [{'id': 1, 'name': 'Python'}, {'id': 2, 'name': 'C'}, {'id': 4, 'name': 'Javascript'}]>
-> ê·¸ê²Œ ì•„ë‹ˆë¼ë©´ databaseë¥¼ ê±´ë“œë¦¼.
```
### ğŸ” ì—­ì°¸ì¡°?
```
class City(models.Model):
     name = models.CharField(max_length=20)

class Language(models.Model):
     name = models.CharField(max_length=100)
 
class Person(models.Model):
     city = models.ForeignKey(City, on_delete=models.CASCADE)
     name = models.CharField(max_length=20)
     language = models.ManyToManyField(Language, through='JoinPersonLanguage')

class JoinPersonLanguage(models.Model):
     person = models.ForeignKey(Person, on_delete=models.CASCADE)
     language = models.ForeignKey(Language, on_delete=models.CASCADE)
```
```
>>> seoul = City.objects.get(id=1)
>>> seoul.person_set.values()
<QuerySet [{'id': 1, 'city_id': 1, 'name': 'zunky'}, {'id': 4, 'city_id': 1, 'name': 'byeong-min'}, {'id': 5, 'city_id': 1, 'name': 'sae-geul'}]>
-> ì´ëŸ° ê²½ìš° seoulì´ë¼ëŠ” Cityì˜ ê°ì²´í•˜ë‚˜ë¿ì´ì§€ë§Œ, ë§Œì•½ ëª¨ë“  City ê°ì²´ë“¤ì— ì—­ì°¸ì¡°ë¥¼ í•´ì•¼í•˜ëŠ” ìƒí™©ì´ë¼ë©´ person_setì´ë¼ëŠ” Queryë¥¼ Cityì˜ ìˆ˜ë§ˆë‹¤ DBì— ìš”ì²­í•˜ê²Œ ë¨.

cities = City.objects.all()
for city in cities:
  print(city.person_set.values())
  
-> ìœ„ì™€ ê°™ì´ ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤ë©´ Cityì˜ ê°ì²´ìˆ˜ ë§Œí¼ Queryë¥¼ DBì— ìš”ì²­í•˜ê²Œ ë˜ëŠ” ê²ƒ.
Cityì˜ ê°ì²´ê°€ seoul, incheon, busanì´ë¼ë©´ QueryëŠ” 3ë²ˆ ìš”ì²­.

-> ì´ëŸ° ìƒí™©ì¼ ë•Œ, prefetch_related()ë¥¼ ì‚¬ìš©í•˜ë©´ Queryë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŒ.

cities = City.objects.prefetch_related('person_set').all()
for city in cities:
  print(city.person_set.values())
```

## ğŸ† Models.py
```
class Company(models.Model):
    tags = models.ManyToManyField('Tag', through='CompanyTag', blank=True)
    
    class Meta:
        db_table = 'companies'

# ManyToManyFieldì—ì„œ Tagë¥¼ ê°–ê³  ìˆë‹¤ë©´ Company í…Œì´ë¸”ì—ëŠ” ì‹¤ì œë¡œ idê°’ ë°–ì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
# Companyì—ì„œ ë°”ë¡œ tagsë¡œ ì—°ê²°ì´ ê°€ëŠ¥í•˜ë‹¤. company.tags ì´ëŸ°ì‹ìœ¼ë¡œ

class CompanyTag(models.Model):
    company = models.ForeignKey('Company', on_delete=models.CASCADE)
    tag     = models.ForeignKey('Tag', on_delete=models.CASCADE)

    class Meta:
        db_table = 'company_tags'

# ì¤‘ê°„í…Œì´ë¸”ë¡œ ì‘ë™í•˜ëŠ” CompanyTag í…Œì´ë¸”ì€ Companyì™€ Tagë¥¼ ForeignKeyë¡œ ë¬¼ê³  ìˆë‹¤.
# ë‘ ì»¬ëŸ¼ ëª¨ë‘ int ê°’ì„ ê°–ê³  ìˆìŒ

class Tag(models.Model):
    name = models.CharField(max_length=100)
    lang = models.CharField(max_length=100)
    
    class Meta:
        db_table = 'tags'

# Companyì™€ ManyToManyFieldì¸ Tag í…Œì´ë¸”ì€ ë”°ë¡œ Company ì»¬ëŸ¼ì„ ê°–ê³  ìˆì§€ì•ŠìŒ.

class CompanyName(models.Model):
    name = models.CharField(max_length=100)
    lang = models.CharField(max_length=100)
    company = models.ForeignKey('Company', on_delete=models.CASCADE)
    
    class Meta:
        db_table = 'company_names'
        
# Companyë¥¼ ForeignKeyë¡œ ë¬¼ê³  ìˆìœ¼ë©° ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥.
```

## ğŸ† Views.py

#### 1. íšŒì‚¬ëª… ìë™ì™„ì„±: 
-> /search?query="íšŒì‚¬ëª…"ì—ì„œ queryë¥¼ í‚¤ì›Œë“œë¡œ ì‚¬ìš© -> í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ëœ íšŒì‚¬ëª…ì„ ëª¨ë‘ ì°¾ìŒ.
-> ì°¾ì€ íšŒì‚¬ëª…ë“¤ì„ ì´ìš©í•´ ë‹¤ë¥¸ ì–¸ì–´ë¡œ í‘œí˜„ë˜ëŠ” ê°™ì€ íšŒì‚¬ì˜ íšŒì‚¬ëª…ë“¤ì„ ëª¨ë‘ ì°¾ê¸°.
-> ì´í›„ì— x-wanted-language í—¤ë” ê°’ì— ë§ëŠ” ì–¸ì–´ë¡œ í‘œí˜„ëœ íšŒì‚¬ëª…ë“¤ì„ ì¶”ë ¤ì„œ ë°˜í™˜.

```
class CompanyView(View):
    def get(self, request):
        user_lang = request.headers.get('x-wanted-language', 'ko')
        # headerì— ë“¤ì–´ì˜¨ x-wanted-language ë°›ì•„ì£¼ê¸°, ì•ˆë“¤ì–´ì˜¤ë©´ koê°€ ê¸°ë³¸ê°’.
        keyword = request.GET.get('query', '')
		# ì¿¼ë¦¬íŒŒë¼ë¯¸í„° ì‚¬ìš©í•´ì„œ queryë¡œ ë“¤ì–´ì˜¨ê±¸ keywordì— ë„£ì–´ì£¼ê³  ì—†ìœ¼ë©´ ë¹ˆê°’ì²˜ë¦¬.
        company_names = list(CompanyName.objects.filter(name__icontains=keyword))
		# íšŒì‚¬ì´ë¦„ì— keywordê°€ ëŒ€/ì†Œë¬¸ì í˜•íƒœë¡œ í¬í•¨ë˜ì–´ìˆìœ¼ë©´ í•„í„°ë§í•´ì¤Œ -> ë¦¬ìŠ¤íŠ¸ë¡œ company_namesì— ë„£ê¸°.
        company_ids = list(map(lambda company_name: company_name.company.id, company_names))
        # company_namesë¼ëŠ” ë¦¬ìŠ¤íŠ¸ì—ì„œ í•„í„°ëœ íšŒì‚¬ì´ë¦„ í•˜ë‚˜ì”© ë¹¼ì„œcompany_name.id ê°’ ì°¾ì•„ì£¼ê³  ê±”ë„¤ë“¤ì„ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ company_ids ë³€ìˆ˜ì— ë‹´ëŠ”ë‹¤.
        global_company_names = CompanyName.objects.filter(company_id__in=company_ids)
		company_idsì— company_idê°€ ìˆëŠ” ì• ë“¤ í•„í„°í•´ì„œ global_company_namesì— ë‹´ê¸°.
        results = [
            {'company_name': company_name.name}
            for company_name in global_company_names
            if company_name.lang == user_lang
        ]
        # ifë¬¸ìœ¼ë¡œ íšŒì‚¬ì´ë¦„ì˜ ì–¸ì–´ ì¡°ê±´ê±¸ì–´ì£¼ê³ , ìœ„ì—ì„œ í•„í„°ëœ global_company_namesë¥¼ for ë¬¸ ëŒë ¤ì£¼ê¸°.
        return JsonResponse(data={'data': results}, status=200)
```

#### 2. íšŒì‚¬ëª…ìœ¼ë¡œ íšŒì‚¬ ê²€ìƒ‰í•˜ê¸°: 
-> /companies/<keyword>ì˜ urlì—ì„œ keywordì— íšŒì‚¬ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰.
-> Headerì˜ x-wanted-languageë¡œ ko(í•œêµ­), en(ì˜ì–´), ja(ì¼ë³¸) ë“± ì–¸ì–´ë¥¼ ì„ íƒí•˜ì—¬ ì…ë ¥.
-> keywordì— ì…ë ¥ëœ íšŒì‚¬ì´ë¦„ê³¼ headerì—ì„œ ì„ íƒí•œ ì–¸ì–´ë¥¼ í† ëŒ€ë¡œ íšŒì‚¬ì´ë¦„ê³¼ íƒœê·¸ë¥¼ ì¶œë ¥í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„.
-> ê²€ìƒ‰ëœ íšŒì‚¬ê°€ ì—†ëŠ” ê²½ìš° 404ë¥¼ ë¦¬í„´í•˜ê³  ì—ëŸ¬ë©”ì‹œì§€ê°€ ì¶œë ¥.
```
class SearchCompanyView(View):
    def get(self, request, keyword): 
    # keyword ì¸ìë¥¼ ë°›ì•„ì¤Œ / ì´ë ‡ê²Œ ë“¤ì–´ê°€ë©´ path paratmeterê°’ìœ¼ë¡œ ë“¤ì–´ê°(/companies/keyword)
        user_lang = request.headers.get('x-wanted-language', 'ko')
		# headerì— ë“¤ì–´ì˜¤ëŠ” x-wanted-languageì˜ ê°’ì„ user_langì— ë‹´ìŒ, ê°’ ì•ˆë“¤ì–´ì˜¤ë©´ 'ko'ë¡œ.
        
        try:
            company_name = CompanyName.objects.get(name=keyword)
        # name=keywordì¸ CompanyNameì„ ì°¾ê³  ê·¸ê±¸ ë³€ìˆ˜ company_nameì— ë‹´ì•„ì¤Œ.
        
        except CompanyName.DoesNotExist:
            return JsonResponse({'message': 'company not found'}, status=404)
        # ì¡´ì¬í•˜ì§€ì•ŠëŠ” íšŒì‚¬ë¼ë©´ CompanyName.DoesNotExist errorë¥¼ ë„ì›Œì£¼ê¸°.
        
        else:
            user_company_name = CompanyName.objects.get(company_id=company_name.company.id, lang=user_lang)
        # keywordë¡œ ê±°ë¥¸ company_nameì˜ company.idì™€ ê°™ì€ company_idë¥¼ ì°¾ê³ , langì€ user_langìœ¼ë¡œ ì°¾ì•„ì„œ getìœ¼ë¡œ í•˜ë‚˜ë¥¼ ê±¸ëŸ¬ì¤Œ. ê·¸ê±¸ user_company_nameì— ë‹´ìŒ.
        
            company_info = {
                'company_name': user_company_name.name,
                'tags': [tag.name for tag in user_company_name.company.tags.all() if tag.lang == user_lang]
            }
            # ìµœì¢…ì ìœ¼ë¡œ company_nameê³¼ tagsë¥¼ ë°˜í™˜ì‹œì¼œì¤„ê±´ë°,
            # user_company_name.company.tags.all()ë¡œ ë°›ê³  for ë¬¸ ëŒë ¤ì¤˜ì„œ tag.name
            # ì¡°ê±´ì„ ê±¸ì–´ì£¼ê¸° -> tag.langì´ user_langê³¼ ê°™ë‹¤ë©´! tagì—ë„ ì–¸ì–´ ê±¸ì–´ì£¼ê¸°. 
            # company_idì™€ langì´ ë™ì¼í•œ companyì˜ ì´ë¦„ì„ ë°˜í™˜.
            return JsonResponse(data=company_info, status=200)
```

